version: '2'

services:
  static:
    image: nginx:alpine
    volumes:
      - ./conf:/conf
      - ./conf/default.conf:/etc/nginx/conf.d/default.conf
      - "${DEVENV_WEB_PATH}:/var/www"
    labels:
      - "traefik.http.routers.static-devenv-http.rule=HostRegexp(`{subdomain:[a-z0-9]+}.dev.env`)"
      - "traefik.http.routers.static-devenv-http.priority=5"
      - "traefik.http.routers.static-devenv-http.tls=false"
      - "traefik.http.routers.static-devenv-https.rule=HostRegexp(`{subdomain:[a-z0-9]+}.dev.env`)"
      - "traefik.http.routers.static-devenv-https.priority=5"
      - "traefik.http.routers.static-devenv-https.tls=true"
    restart: always
    networks:
      - devenv


  traefik:
    image: traefik
    command: 
      #- "--log.level=DEBUG"
      - "--api=true"
      - "--entryPoints.web.address=:80"
      - "--entryPoints.websecure.address=:443"
      - "--providers.docker=true"
      - "--providers.docker.defaultRule=Host(`{{ replace \",\" \".dev.env`,`\" (or .Labels.Subdomains .Name) }}.dev.env`)"
      - "--providers.file.filename=/conf/dynamic.toml"
      - "--providers.file.watch=true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # So that Traefik can listen to the Docker events
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./conf:/conf
    labels:
      - "Subdomains=traefik"
      - "traefik.http.routers.api-devenv-http.service=api@internal"
      - "traefik.http.routers.api-devenv-http.tls=false"
      - "traefik.http.routers.api-devenv-https.service=api@internal"
      - "traefik.http.routers.api-devenv-https.tls=true"
    restart: always
    networks:
      - devenv


  whoami:
    image: containous/whoami
    labels:
      - "Subdomains=whoami"
      - "traefik.http.routers.whoami-devenv-http.tls=false"
      - "traefik.http.routers.whoami-devenv-https.tls=true"
    restart: always
    networks:
      - devenv


  dnsmasq:
    image: dnsmasq
    build: dnsmasq/
    ports: 
      - "127.0.0.1:53:53/udp"
    volumes:
      - ./dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf
    cap_add:
      - NET_ADMIN
    labels:
      - "traefik.enable=false"
    restart: always
    networks:
      - devenv


networks: 
  devenv:
    external: true
